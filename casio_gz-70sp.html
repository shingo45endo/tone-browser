<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0"> 
<title>tone-browser</title>
<link href="./common.css" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p" crossorigin="anonymous"></script>
<script type="module">
/* global bootstrap */
import {html, render} from 'https://unpkg.com/lit-html?module';
import {formatters as fmt} from './formatters.js';

const templateToneList = (json) => html`
	<table class="table table-sm table-hover w-auto mb-0">
		<thead>
			<tr>
				<th class="text-end">No.</th>
				<th>Program</th>
				<th># of Voice</th>
			</tr>
		</thead>
		<tbody>
		${json.tones.map((tone) => html`
			<tr>
				<td class="text-end">${tone.toneNo}</td>
				<td class="font-monospace"><a href="#/tones/${tone.toneNo}">${tone.name}</a></td>
				<td class="text-end">${tone.voices.length}</td>
			</tr>
		`)}
		</tbody>
	</table>
`;

const templateSampleList = (json) => html`
	<table class="table table-sm table-hover w-auto mb-0">
		<thead>
			<tr>
				<th class="text-end ps-4">No.</th>
				<th>Name</th>
				<th class="text-end ps-4">Level</th>
				<th class="text-end ps-4">Pitch</th>
				<th class="text-end ps-4">Exp.</th>
				<th class="text-end">Start Addr.</th>
				<th class="text-end">End Addr.</th>
				<th class="text-end">Loop Addr.</th>
				<th class="text-end">Sample Len.</th>
				<th class="text-end">Loop Len.</th>
			</tr>
		</thead>
		<tbody>
		${json.samples.map((sample) => html`
			<tr>
				<td class="text-end">${sample.sampleNo}</td>
				<td class="font-monospace">${sample.name}</td>
				<td class="text-end">${sample.level}</td>
				<td class="text-end">${sample.pitch}</td>
				<td class="text-end">${sample.exponent}</td>
				<td class="text-end font-monospace">${sample.startAddr.toString(16).padStart(6, '0')}</td>
				<td class="text-end font-monospace">${sample.endAddr.toString(16).padStart(6, '0')}</td>
				<td class="text-end font-monospace">${sample.loopAddr.toString(16).padStart(6, '0')}</td>
				<td class="text-end">${sample.endAddr - sample.startAddr}</td>
				<td class="text-end">${sample.endAddr - sample.loopAddr}</td>
			</tr>
		`)}
		</tbody>
	</table>
`;

const templateVoice = (voice, i, json) => html`
	<div class="col-md-6 col-sm-12">
		<div class="card mb-3">
			<div class="card-header">
				<h3 class="h6 mb-0">Sample ${i + 1}</h3>
			</div>
			<div class="card-body d-flex flex-row">
				<div>
					<table class="table table-sm w-auto">
						<tbody>
							<tr>
								<th>Pitch Key Follow</th>
								<td class="text-end">${(voice.pitchKeyFollow !== 7) ? `1/${2 ** voice.pitchKeyFollow}` : '-'}</td>
							</tr>
							<tr>
								<th>Pitch Tune</th>
								<td class="text-end">${voice.pitchTune}</td>
							</tr>
							<tr>
								<th>Panpot</th>
								<td class="text-end">${voice.panpot}</td>
							</tr>
							<tr>
								<th>Velocity Sensitivity Depth</th>
								<td class="text-end">${voice.velSensDepth}</td>
							</tr>
							<tr>
								<th>Velocity Sensitivity Offset</th>
								<td class="text-end">${voice.velSensOffset}</td>
							</tr>
						</tbody>
					</table>
					<table class="table table-sm table-hover w-auto mb-0">
						<thead>
							<tr>
								<th class="text-end">Note</th>
								<th class="text-end">No.</th>
								<th class="text-end">Sample No.</th>
								<th>Sample Name</th>
							</tr>
						</thead>
						<tbody>
						${voice.samples.map((sample, noteNo) => html`
							<tr class="${(12 < noteNo && noteNo <= 108) ? '' : 'd-none'}">
								<td class="text-end">${fmt.noteNameR(noteNo)}</td>
								<td class="text-end text-muted">${noteNo}</td>
								<td class="text-end">${sample.sampleNo}</td>
								<td class="font-monospace">${sample.name}</td>
							</tr>
						`)}
						</tbody>
					</table>
				</div>
			</div>
		</div>
	</div>
`;

const templateTone = (tone, json) => html`
	<h2 class="h6">Program No.${tone.toneNo}: <span class="font-monospace h4">${tone.name}</span></h2>
	<div class="row">
		${tone.voices.map((voice, i) => templateVoice(voice, i, json))}
	</div>
`;

window.addEventListener('DOMContentLoaded', async () => {
	const elemModal = new bootstrap.Modal(document.getElementById('my-modal'));
	const modalContent = document.getElementById('my-modal-content');

	elemModal.show();

	// Loads a JSON file.
	const url = (window.location.search.startsWith('?')) ? window.location.search.slice(1) : 'gz-70sp.json';
	const res = await fetch(url);
	if (!res.ok) {
		modalContent.textContent = `Error: "${url}" not found.`;
		return;
	}
	const json = await res.json();
	modalContent.textContent = '';

	// Adds event handlers.
	window.addEventListener('hashchange', handleHashChange);
	document.getElementById('my-modal').addEventListener('hide.bs.modal', () => {
		if (window.location.hash !== '' && window.history.length > 2) {
			window.history.back();
		} else {
			window.location.hash = '';
		}
	});

	// Renders lists on each tab pane.
	render(templateToneList(json), document.getElementById('my-pane-tones'));
	render(templateSampleList(json), document.getElementById('my-pane-samples'));

	handleHashChange();

	function handleHashChange() {
		// Checks whether the current URL hash is a supported format or not.
		const m = window.location.hash.match(/^#\/(.*)\/(\d+)/u);
		if (!m) {
			elemModal.hide();
			return;
		}

		// Renders information on the modal according to the specified URL hash.
		const no = Number(m[2]);
		switch (m[1]) {
		case 'tones':
			render(templateTone(json.tones[no], json), modalContent);
			break;
		default:
			elemModal.hide();
			return;
		}

		// Shows the modal.
		document.getElementById('my-modal-title').textContent = window.location.hash;
		elemModal.show();
	}
});
</script>
<body>
	<!-- Navbar -->
	<nav class="navbar sticky-top bg-light">
		<div class="container align-items-start">
			<h1 class="h5 mt-1 mb-0">tone-browser</h1>
			<a href="#" class="btn btn-outline-primary py-1">Top</a>
		</div>
	</nav>

	<!-- Main screen -->
	<main class="container mt-2">
		<ul class="nav nav-tabs" role="tablist">
			<li class="nav-item" role="presentation">
				<button id="my-tab-tones" class="nav-item nav-link active" role="tab" data-bs-toggle="tab" data-bs-target="#my-pane-tones">Tones</button>
			</li>
			<li class="nav-item" role="presentation">
				<button id="my-tab-waves" class="nav-item nav-link" role="tab" data-bs-toggle="tab" data-bs-target="#my-pane-samples">Samples</button>
			</li>
		</ul>
		<div class="tab-content mt-2">
			<div id="my-pane-tones" class="tab-pane fade show active" role="tabpanel"></div>
			<div id="my-pane-samples" class="tab-pane fade" role="tabpanel"></div>
		</div>
	</main>

	<!-- Information modal -->
	<div id="my-modal" class="modal" tabindex="-1" role="dialog">
		<div class="modal-dialog modal-dialog-scrollable modal-xl my-modal-fluid" role="document">
			<div class="modal-content">
				<div class="modal-header">
					<h2 id="my-modal-title" class="modal-title h6 text-black-50"></h2>
					<button type="button" class="btn-close" data-bs-dismiss="modal"></button>
				</div>
				<div class="modal-body">
					<div id="my-modal-content" class="container-fluid">
						Loading...
					</div>
				</div>
			</div>
		</div>
	</div>
</body>
</html>
