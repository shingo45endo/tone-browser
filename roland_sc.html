<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0"> 
<title>tone-browser</title>
<link href="./common.css" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p" crossorigin="anonymous"></script>
<script type="module">
/* global bootstrap */
import {html} from 'https://unpkg.com/lit-html?module';
import {makeDomLoadedHandler} from './common.js';
import {formatters as fmt} from './formatters.js';

const templateProgramList = (json) => html`
	<table class="table table-sm table-hover w-auto mb-0">
		<thead>
			<tr>
				<th class="text-end">BankL</th>
				<th class="text-end">Prog#</th>
				<th class="text-end">BankM</th>
				<th class="text-end ps-4">No.</th>
				<th>Instrument</th>
			</tr>
		</thead>
		<tbody>
		${json.programs.map((program) => html`
			<tr>
				<td class="text-end">${program.bankL}</td>
				<td class="text-end">${program.prog}</td>
				<td class="text-end">${program.bankM}</td>
				<td class="text-end">${getRef(program).replace(/^.*\//u, '')}</td>
				<td class="font-monospace"><a href="${getRef(program)}">${program.name}</a></td>
			</tr>
		`)}
		</tbody>
	</table>
`;

function getRef(program) {
	for (const key of ['tone', 'tone4', 'combi']) {
		if (program[key] && program[key].$ref) {
			return program[key].$ref;
		}
	}
	console.assert(false);
	return null;
}

const templateProgDrumList = (json) => html`
	<table class="table table-sm table-hover w-auto mb-0">
		<thead>
			<tr>
				<th class="text-end">BankL</th>
				<th class="text-end">Prog#</th>
				<th class="text-end ps-4">No.</th>
				<th>Instrument</th>
			</tr>
		</thead>
		<tbody>
		${json.progDrums.map((progDrum) => html`
			<tr>
				<td class="text-end">${progDrum.bankL}</td>
				<td class="text-end">${progDrum.prog}</td>
				<td class="text-end">${progDrum.drumNo}</td>
				<td class="font-monospace"><a href="${progDrum.drumSet.$ref}">${progDrum.drumSet.name}</a></td>
			</tr>
		`)}
		</tbody>
	</table>
`;

const templateToneList = (json) => html`
	<table class="table table-sm table-hover w-auto mb-0">
		<thead>
			<tr>
				<th class="text-end">No.</th>
				<th>Instrument</th>
				<th class="text-end ps-4">No.</th>
				<th>Wave 1</th>
				<th class="text-end ps-4">No.</th>
				<th>Wave 2</th>
			</tr>
		</thead>
		<tbody>
		${json.tones.map((tone) => html`
			<tr>
				<td class="text-end">${tone.toneNo}</td>
				<td class="font-monospace"><a href="#/tones/${tone.toneNo}">${tone.name}</a></td>
				<td class="text-end">${tone.voices[0].waveNo}</td>
				<td class="font-monospace">${tone.voices[0].wave.name}</td>
				<td class="text-end">${tone.voices[1] ? tone.voices[1].waveNo : ''}</td>
				<td class="font-monospace">${tone.voices[1] ? tone.voices[1].wave.name : ''}</td>
			</tr>
		`)}
		</tbody>
	</table>
`;

const templateToneList4 = (json) => html`
	<table class="table table-sm table-hover w-auto mb-0">
		<thead>
			<tr>
				<th class="text-end">No.</th>
				<th>Instrument</th>
				<th class="text-end ps-4">No.</th>
				<th>Wave 1</th>
				<th class="text-end ps-4">No.</th>
				<th>Wave 2</th>
				<th class="text-end ps-4">No.</th>
				<th>Wave 3</th>
				<th class="text-end ps-4">No.</th>
				<th>Wave 4</th>
			</tr>
		</thead>
		<tbody>
		${json.tones4.map((tone) => html`
			<tr>
				<td class="text-end">${tone.toneNo}</td>
				<td class="font-monospace"><a href="#/tones4/${tone.toneNo}">${tone.name}</a></td>
				<td class="text-end">${tone.voices[0].waveNo}</td>
				<td class="font-monospace">${tone.voices[0].wave.name}</td>
				<td class="text-end">${tone.voices[1].waveNo}</td>
				<td class="font-monospace">${tone.voices[1].wave.name}</td>
				<td class="text-end">${tone.voices[2].waveNo}</td>
				<td class="font-monospace">${tone.voices[2].wave.name}</td>
				<td class="text-end">${tone.voices[3].waveNo}</td>
				<td class="font-monospace">${tone.voices[3].wave.name}</td>
			</tr>
		`)}
		</tbody>
	</table>
`;

const templateCombiList = (json) => html`
	<table class="table table-sm table-hover w-auto mb-0">
		<thead>
			<tr>
				<th class="text-end">No.</th>
				<th>Instrument</th>
				<th class="text-end ps-4">No.</th>
				<th>Instrument 1</th>
				<th class="text-end ps-4">No.</th>
				<th>Instrument 2</th>
			</tr>
		</thead>
		<tbody>
		${json.combis.map((combi) => html`
			<tr>
				<td class="text-end">${combi.combiNo}</td>
				<td class="font-monospace"><a href="#/combis/${combi.combiNo}">${combi.name}</a></td>
				<td class="text-end">${combi.tones[0].toneNo}</td>
				<td class="font-monospace"><a href="${combi.tones[0].tone.$ref}">${json.tones[combi.tones[0].toneNo].name}</a></td>
				<td class="text-end">${combi.tones[1].toneNo}</td>
				<td class="font-monospace"><a href="${combi.tones[1].tone.$ref}">${json.tones[combi.tones[1].toneNo].name}</a></td>
			</tr>
		`)}
		</tbody>
	</table>
`;

const templateWaveList = (json) => html`
	<table class="table table-sm table-hover w-auto mb-0">
		<thead>
			<tr>
				<th class="text-end">No.</th>
				<th>Wave</th>
				<th>Sample Data</th>
			</tr>
		</thead>
		<tbody>
		${json.waves.map((wave) => html`
			<tr>
				<td class="text-end">${wave.waveNo}</td>
				<td class="font-monospace">${wave.name}</td>
				<td>
					<table class="table table-sm table-borderless w-auto mb-0">
						<thead>
							<tr>
								<th>Low</th>
								<th>No.</th>
								<th>High</th>
								<th>No.</th>
								<th>Level</th>
								<th>Sample No.</th>
								<th>Orig.</th>
								<th>No.</th>
							</tr>
						<thead>
						<tbody>
						${wave.multiSamples.map((multiSample) => html`
							<tr>
								<td class="text-end">${fmt.noteNameR(multiSample.low)}</td>
								<td class="text-end text-muted">${multiSample.low}</td>
								<td class="text-end">${fmt.noteNameR(multiSample.high)}</td>
								<td class="text-end text-muted">${multiSample.high}</td>
								<td class="text-end">${multiSample.level}</td>
								<td class="text-end">${multiSample.sampleNo}</td>
								${((sample) => html`
								<td class="text-end">${(sample) ? fmt.noteNameR(sample.key) : '--'}</td>
								<td class="text-end text-muted">${(sample) ? sample.key : '--'}</td>
								`)(json.samples[multiSample.sampleNo])}
							</tr>
						`)}
						<tbody>
					</table>
				</td>
			</tr>
		`)}
		</tbody>
	</table>
`;

const templateVoice = (voice, json) => html`
	<div class="card mb-3">
		<div class="card-header">
			<h3 class="h6 mb-0">Wave No.${voice.waveNo}: <span class="font-monospace h4">${voice.wave.name}</span></h3>
		</div>
		<div class="card-body d-flex flex-row">
			<table class="table table-sm w-auto mb-0 me-3">
				<tbody>
					<tr>
						<th>Tone Delay Mode</th>
						<td class="text-end">${voice.bytes[0]}</td>
					</tr>
					<tr>
						<th>Tone Pan</th>
						<td class="text-end">${fmt.panpotR(voice.bytes[15])}</td>
					</tr>
					<tr>
						<th>Pan Keyfollow Switch</th>
						<td class="text-end">${fmt.onOff(voice.bytes[107])}</td>
					</tr>
					<tr>
						<th>Coarse Tune</th>
						<td class="text-end">${fmt.sint7offset6(voice.bytes[16])}</td>
					</tr>
					<tr>
						<th>Fine Tune</th>
						<td class="text-end">${fmt.sint7offset6(voice.bytes[17])}</td>
					</tr>
					<tr>
						<th>Pitch Keyfollow</th>
						<td class="text-end">${voice.bytes[19]}</td>
					</tr>
					<tr>
						<th>Velocity Range Lower</th>
						<td class="text-end">${voice.bytes[79]}</td>
					</tr>
					<tr>
						<th>Velocity Range Upper</th>
						<td class="text-end">${voice.bytes[81]}</td>
					</tr>
				</tbody>
			</table>
			<!-- Pitch Env. -->
			<table class="table table-sm w-auto mb-0 me-3">
				<thead>
					<tr>
						<th>Pitch Env.</th>
						<th class="text-end">1</th>
						<th class="text-end">2</th>
						<th class="text-end">3</th>
						<th class="text-end">4</th>
						<th class="text-end">5</th>
					</tr>
				</thead>
				<tbody>
					<tr>
						<th>Time</th>
						<td class="text-end">${voice.bytes[32]}</td>
						<td class="text-end">${voice.bytes[33]}</td>
						<td class="text-end">${voice.bytes[34]}</td>
						<td class="text-end">${voice.bytes[35]}</td>
						<td class="text-end">${voice.bytes[36]}</td>
					</tr>
					<tr>
						<th>Level</th>
						<td class="text-end">${fmt.sint7offset6(voice.bytes[27])}</td>
						<td class="text-end">${fmt.sint7offset6(voice.bytes[28])}</td>
						<td class="text-end">${fmt.sint7offset6(voice.bytes[29])}</td>
						<td class="text-end">${fmt.sint7offset6(voice.bytes[30])}</td>
						<td class="text-end">${fmt.sint7offset6(voice.bytes[31])}</td>
					</tr>
				</tbody>
			</table>
			<!-- TVF Env. -->
			<table class="table table-sm w-auto mb-0 me-3">
				<thead>
					<tr>
						<th>TVF Env.</th>
						<th class="text-end">1</th>
						<th class="text-end">2</th>
						<th class="text-end">3</th>
						<th class="text-end">4</th>
						<th class="text-end">5</th>
					</tr>
				</thead>
				<tbody>
					<tr>
						<th>Time</th>
						<td class="text-end">${voice.bytes[63]}</td>
						<td class="text-end">${voice.bytes[64]}</td>
						<td class="text-end">${voice.bytes[65]}</td>
						<td class="text-end">${voice.bytes[66]}</td>
						<td class="text-end">${voice.bytes[67]}</td>
					</tr>
					<tr>
						<th>Level</th>
						<td class="text-end">${voice.bytes[58]}</td>
						<td class="text-end">${voice.bytes[59]}</td>
						<td class="text-end">${voice.bytes[60]}</td>
						<td class="text-end">${voice.bytes[61]}</td>
						<td class="text-end">${voice.bytes[62]}</td>
					</tr>
				</tbody>
			</table>
			<!-- TVA Env. -->
			<table class="table table-sm w-auto mb-0 me-3">
				<thead>
					<tr>
						<th>TVA Env.</th>
						<th class="text-end">1</th>
						<th class="text-end">2</th>
						<th class="text-end">3</th>
						<th class="text-end">4</th>
						<th class="text-end">5</th>
					</tr>
				</thead>
				<tbody>
					<tr>
						<th>Time</th>
						<td class="text-end">${fmt.mask7(voice.bytes[94])}</td>
						<td class="text-end">${fmt.mask7(voice.bytes[95])}</td>
						<td class="text-end">${fmt.mask7(voice.bytes[96])}</td>
						<td class="text-end">${fmt.mask7(voice.bytes[97])}</td>
						<td class="text-end">${fmt.mask7(voice.bytes[98])}</td>
					</tr>
					<tr>
						<th>Level</th>
						<td class="text-end">${voice.bytes[90]}</td>
						<td class="text-end">${voice.bytes[91]}</td>
						<td class="text-end">${voice.bytes[92]}</td>
						<td class="text-end">${voice.bytes[93]}</td>
						<td class="text-end">-</td>
					</tr>
				</tbody>
			</table>
		</div>
	</div>
`;

const templateTone = (tone, json) => html`
	<div class="card mb-3">
		<div class="card-header">
			<h2 class="h6 mb-0">Instrument No.${tone.toneNo}: <span class="font-monospace h4">${tone.name}</span></h2>
		</div>
		<div class="card-body d-flex flex-row">
			<table class="table table-sm w-auto mb-0 me-3">
				<tbody>
					<tr>
						<th>Patch Level</th>
						<td class="text-end">${tone.commonBytes[12]}</td>
					</tr>
				</tbody>
			</table>
			<table class="table table-sm w-auto mb-0 me-3">
				<tbody>
					<tr>
						<th>Random Switch</th>
						<td class="text-end">${fmt.onOff(tone.commonBytes[34])}</td>
					</tr>
				</tbody>
			</table>
			<table class="table table-sm w-auto mb-0 me-3">
				<tbody>
					<tr>
						<th>Common 13</th>
						<td class="text-end">${tone.commonBytes[13]}</td>
					</tr>
					<tr>
						<th>Common 14</th>
						<td class="text-end">${tone.commonBytes[14]}</td>
					</tr>
					<tr>
						<th>Common 19</th>
						<td class="text-end">${tone.commonBytes[19]}</td>
					</tr>
					<tr>
						<th>Common 20</th>
						<td class="text-end">${tone.commonBytes[20]}</td>
					</tr>
					<tr>
						<th>Common 21</th>
						<td class="text-end">${tone.commonBytes[21]}</td>
					</tr>
					<tr>
						<th>Common 23</th>
						<td class="text-end">${tone.commonBytes[23]}</td>
					</tr>
				</tbody>
			</table>
		</div>
	</div>
	${tone.voices.map((voice) => templateVoice(voice, json))}
`;

const templateCombi = (combi, json) => html`
	<h2 class="font-monospace h4">${combi.name}</h2>
	<ul class="nav nav-tabs" role="tablist">
		<li class="nav-item" role="presentation">
			<button id="my-tab-tone0" class="nav-item nav-link active" role="tab" data-bs-toggle="tab" data-bs-target="#my-pane-tone0">${json.tones[combi.tones[0].toneNo].name}</button>
		</li>
		<li class="nav-item" role="presentation">
			<button id="my-tab-tone1" class="nav-item nav-link" role="tab" data-bs-toggle="tab" data-bs-target="#my-pane-tone1">${json.tones[combi.tones[1].toneNo].name}</button>
		</li>
	</ul>
	<div class="tab-content mt-2">
		<div id="my-pane-tone0" class="tab-pane fade show active" role="tabpanel">
			${templateTone(json.tones[combi.tones[0].toneNo], json)}
		</div>
		<div id="my-pane-tone1" class="tab-pane fade" role="tabpanel">
			${templateTone(json.tones[combi.tones[1].toneNo], json)}
		</div>
	</div>
`;

const templateDrumSet = (drumSet, json) => html`
	<h2 class="font-monospace h4">${drumSet.name}</h2>
	<table class="table table-sm table-hover w-auto mb-0">
		<thead>
			<tr>
				<th class="text-end">Note</th>
				<th class="text-end">No.</th>
				<th>Name</th>
				<th class="text-end ps-4">No.</th>
				<th>Instrument</th>
				<th class="text-end ps-4">Level</th>
				<th class="text-end">Pitch</th>
				<th class="text-end">Group</th>
				<th class="text-end">Panpot</th>
				<th class="text-end">Reverb</th>
				<th class="text-end">Chorus</th>
				<th class="text-end">Delay</th>
				<th class="text-end">Note On</th>
				<th class="text-end">Note Off</th>
			</tr>
		</thead>
		<tbody>
		${(Object.entries(drumSet.notes).map((e) => [Number(e[0]), e[1]]).sort((a, b) => a[0] > b[0])).map((e) => {
			const [noteNo, note] = e;
			return html`
			<tr>
				<td class="text-end">${fmt.noteNameR(noteNo)}</td>
				<td class="text-end text-muted">${noteNo}</td>
				<td class="font-monospace">${note.name}</td>
				<td class="text-end">${note.toneNo}</td>
				<td class="font-monospace"><a href="${note.tone.$ref}">${note.tone.name}</a></td>
				<td class="text-end">${note.level}</td>
				<td class="text-end">${note.pitch}</td>
				<td class="text-end">${note.group}</td>
				<td class="text-end">${fmt.panpotR(note.panpot)}</td>
				<td class="text-end">${note.reverb}</td>
				<td class="text-end">${note.chorus}</td>
				<td class="text-end">${note.delay}</td>
				<td class="text-end">${fmt.onOff(note.isRxNoteOn)}</td>
				<td class="text-end">${fmt.onOff(note.isRxNoteOff)}</td>
			</tr>
			`;
		})}
		</tbody>
	</table>
`;

window.addEventListener('DOMContentLoaded', makeDomLoadedHandler({
	lists: [
		{id: 'programs',  label: 'Programs',              renderer: templateProgramList},
		{id: 'progdrums', label: 'Programs (Drum Set)',   renderer: templateProgDrumList},
		{id: 'tones',     label: 'Instruments',           renderer: templateToneList},
		{id: 'tones4',    label: 'Instruments (4-voice)', renderer: templateToneList4},
		{id: 'combis',    label: 'Instruments (Legato)',  renderer: templateCombiList},
		{id: 'waves',     label: 'Waves',                 renderer: templateWaveList},
	],
	details: {
		tones:    templateTone,
		tones4:   templateTone,
		combis:   templateCombi,
		drumSets: templateDrumSet,
	},
}, bootstrap.Modal.getOrCreateInstance.bind(bootstrap.Modal)));
</script>
<body>
</body>
</html>
