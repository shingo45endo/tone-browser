<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0"> 
<title>tone-browser</title>
<link href="./common.css" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p" crossorigin="anonymous"></script>
<script type="module">
/* global bootstrap */
import {html, render} from 'https://unpkg.com/lit-html?module';
import {formatters as fmt} from './formatters.js';

const templateToneList = (json) => html`
	<table class="table table-sm table-hover w-auto mb-0">
		<thead>
			<tr>
				<th class="text-end">No.</th>
				<th>Program</th>
				<th class="text-end ps-4">No.</th>
				<th>Multi Sample 1</th>
				<th class="text-end ps-4">No.</th>
				<th>Multi Sample 2</th>
			</tr>
		</thead>
		<tbody>
		${json.tones.map((tone) => html`
			<tr>
				<td class="text-end">${tone.toneNo}</td>
				<td class="font-monospace"><a href="#/tones/${tone.toneNo}">${tone.name}</a></td>
				<td class="text-end">${(tone.voices[0].toneWave) ? tone.voices[0].toneWaveNo : tone.voices[0].drumSetNo}</td>
				<td class="font-monospace">${(tone.voices[0].toneWave ?? tone.voices[0].drumSet)?.name}</td>
				<td class="text-end">${tone.voices[1] ? ((tone.voices[1].toneWave) ? tone.voices[1].toneWaveNo : tone.voices[1].drumSetNo) : ''}</td>
				<td class="font-monospace">${tone.voices[1] ? (tone.voices[1].toneWave ?? tone.voices[1].drumSet)?.name : ''}</td>
			</tr>
		`)}
		</tbody>
	</table>
`;

const templateWaveList = (json) => html`
	<div class="d-flex flex-row">
		<table class="table table-sm table-hover w-auto mb-0">
			<thead>
				<tr>
					<th class="text-end">No.</th>
					<th>Multi Sample</th>
				</tr>
			</thead>
			<tbody>
			${json.toneWaves.map((toneWave) => html`
				<tr>
					<td class="text-end">${toneWave.toneWaveNo}</td>
					<td class="font-monospace">${toneWave.name}</td>
				</tr>
			`)}
			</tbody>
		</table>
	</div>
`;

const templateVoice = (voice, json) => html`
	<div class="card mb-3">
		<div class="card-header">
			<h3 class="h6 mb-0">Wave No.${(voice.toneWave) ? voice.toneWaveNo : voice.drumSetNo}: <span class="font-monospace h4">${(voice.toneWave ?? voice.drumSet)?.name}</span></h3>
		</div>
		<div class="card-body d-flex flex-row">
			<div class="me-3">
				<table class="table table-sm">
					<tbody>
						<tr>
							<th>Octave</th>
							<td class="text-end">${fmt.sint8(voice.octave)}</td>
						</tr>
					</tbody>
				</table>
				<table class="table table-sm">
					<tbody>
						<tr>
							<th>P.EG Intensity</th>
							<td class="text-end">${fmt.sint8(voice.bytes[0])}</td>
						</tr>
					</tbody>
				</table>
				<table class="table table-sm">
					<tbody>
						<tr>
							<th>P.MG Waveform</th>
							<td class="text-end">${['Tri', 'SawUp', 'SawDn', 'Sq', 'Random'][voice.bytes[1] & 0x07] ?? 'Unknown'}</td>
						</tr>
						<tr>
							<th>P.MG KeySync</th>
							<td class="text-end">${((voice.bytes[1] & 0x80) === 0) ? 'On' : 'Off'}</td>
						</tr>
						<tr>
							<th>P.MG Frequency</th>
							<td class="text-end">${voice.bytes[2]}</td>
						</tr>
						<tr>
							<th>P.MG Delay</th>
							<td class="text-end">${voice.bytes[3]}</td>
						</tr>
						<tr>
							<th>P.MG Fade In</th>
							<td class="text-end">${voice.bytes[4]}</td>
						</tr>
						<tr>
							<th>P.MG Intensity</th>
							<td class="text-end">${voice.bytes[5]}</td>
						</tr>
						<tr>
							<th>P.MG Freq Mod by KbdTrk</th>
							<td class="text-end">${fmt.sint8(voice.bytes[6])}</td>
						</tr>
						<tr>
							<th>P.MG Int Mod by AftT</th>
							<td class="text-end">${voice.bytes[7]}</td>
						</tr>
						<tr>
							<th>P.MG Int Mod by Mod1</th>
							<td class="text-end">${voice.bytes[8]}</td>
						</tr>
						<tr>
							<th>P.MG Freq Mod by AftT+Mod1</th>
							<td class="text-end">${voice.bytes[9]}</td>
						</tr>
					</tbody>
				</table>
			</div>
			<div class="me-3">
				<table class="table table-sm">
					<thead>
						<tr>
							<th>F.EG</th>
							<th class="text-end">A</th>
							<th class="text-end">D</th>
							<th class="text-end">S</th>
							<th class="text-end">R</th>
						</tr>
					</thead>
					<tbody>
						<tr>
							<th>Time</th>
							<td class="text-end">${voice.bytes[17]}</td>
							<td class="text-end">${voice.bytes[19]}</td>
							<td class="text-end">${voice.bytes[21]}</td>
							<td class="text-end">${voice.bytes[23]}</td>
						</tr>
						<tr>
							<th>Level</th>
							<td class="text-end">${fmt.sint8(voice.bytes[18])}</td>
							<td class="text-end">${fmt.sint8(voice.bytes[20])}</td>
							<td class="text-end">${fmt.sint8(voice.bytes[22])}</td>
							<td class="text-end">${fmt.sint8(voice.bytes[24])}</td>
						</tr>
					</tbody>
				</table>
				<table class="table table-sm">
					<thead>
						<tr>
							<th>F.EG Time</th>
							<th class="text-end">A</th>
							<th class="text-end">D</th>
							<th class="text-end">S</th>
							<th class="text-end">R</th>
						</tr>
					</thead>
					<tbody>
						<tr>
							<th>KbdTrk</th>
							<td class="text-end">${((voice.bytes[38] & 0x01) !== 0) ? '+-'[((voice.bytes[38] & 0x10) === 0) ? 0 : 1] : ''}</td>
							<td class="text-end">${((voice.bytes[38] & 0x02) !== 0) ? '+-'[((voice.bytes[38] & 0x20) === 0) ? 0 : 1] : ''}</td>
							<td class="text-end">${((voice.bytes[38] & 0x04) !== 0) ? '+-'[((voice.bytes[38] & 0x40) === 0) ? 0 : 1] : ''}</td>
							<td class="text-end">${((voice.bytes[38] & 0x08) !== 0) ? '+-'[((voice.bytes[38] & 0x80) === 0) ? 0 : 1] : ''}</td>
						</tr>
						<tr>
							<th>VelSense</th>
							<td class="text-end">${((voice.bytes[39] & 0x01) !== 0) ? '+-'[((voice.bytes[39] & 0x10) === 0) ? 0 : 1] : ''}</td>
							<td class="text-end">${((voice.bytes[39] & 0x02) !== 0) ? '+-'[((voice.bytes[39] & 0x20) === 0) ? 0 : 1] : ''}</td>
							<td class="text-end">${((voice.bytes[39] & 0x04) !== 0) ? '+-'[((voice.bytes[39] & 0x40) === 0) ? 0 : 1] : ''}</td>
							<td class="text-end">${((voice.bytes[39] & 0x08) !== 0) ? '+-'[((voice.bytes[39] & 0x80) === 0) ? 0 : 1] : ''}</td>
						</tr>
					</tbody>
				</table>
				<table class="table table-sm">
					<tbody>
						<tr>
							<th>VDF Cutoff</th>
							<td class="text-end">${voice.bytes[10]}</td>
						</tr>
						<tr>
							<th>VDF KbdTrk Key</th>
							<td class="text-end">${fmt.noteNameR(voice.bytes[11])}</td>
						</tr>
						<tr>
							<th>VDF KbdTrk Mode</th>
							<td class="text-end">${['Off', 'Low', 'High', 'All'][voice.bytes[44] & 0x03]}</td>
						</tr>
						<tr>
							<th>VDF KbdTrk</th>
							<td class="text-end">${fmt.sint8(voice.bytes[12])}</td>
						</tr>
						<tr>
							<th>Color Intensity</th>
							<td class="text-end">${voice.bytes[42]}</td>
						</tr>
						<tr>
							<th>Color VelSense</th>
							<td class="text-end">${fmt.sint8(voice.bytes[43])}</td>
						</tr>
					</tbody>
				</table>
				<table class="table table-sm">
					<tbody>
						<tr>
							<th>F.EG Intensity</th>
							<td class="text-end">${fmt.sint8(voice.bytes[13])}</td>
						</tr>
						<tr>
							<th>F.EG Time KbdTrk</th>
							<td class="text-end">${voice.bytes[14]}</td>
						</tr>
						<tr>
							<th>F.EG Time VelSense</th>
							<td class="text-end">${voice.bytes[15]}</td>
						</tr>
						<tr>
							<th>F.EG Int VelSense</th>
							<td class="text-end">${fmt.sint8(voice.bytes[16])}</td>
						</tr>
					</tbody>
				</table>
			</div>
			<div class="me-3">
				<table class="table table-sm">
					<thead>
						<tr>
							<th>A.EG</th>
							<th class="text-end">A</th>
							<th class="text-end">D</th>
							<th class="text-end">S</th>
							<th class="text-end">R</th>
						</tr>
					</thead>
					<tbody>
						<tr>
							<th>Time</th>
							<td class="text-end">${voice.bytes[31]}</td>
							<td class="text-end">${voice.bytes[33]}</td>
							<td class="text-end">${voice.bytes[35]}</td>
							<td class="text-end">${voice.bytes[37]}</td>
						</tr>
						<tr>
							<th>Level</th>
							<td class="text-end">${voice.bytes[32]}</td>
							<td class="text-end">${voice.bytes[34]}</td>
							<td class="text-end">${voice.bytes[36]}</td>
							<td class="text-end">-</td>
						</tr>
					</tbody>
				</table>
				<table class="table table-sm">
					<thead>
						<tr>
							<th>F.EG Time</th>
							<th class="text-end">A</th>
							<th class="text-end">D</th>
							<th class="text-end">S</th>
							<th class="text-end">R</th>
						</tr>
					</thead>
					<tbody>
						<tr>
							<th>KbdTrk</th>
							<td class="text-end">${((voice.bytes[40] & 0x01) !== 0) ? '+-'[((voice.bytes[40] & 0x10) === 0) ? 0 : 1] : ''}</td>
							<td class="text-end">${((voice.bytes[40] & 0x02) !== 0) ? '+-'[((voice.bytes[40] & 0x20) === 0) ? 0 : 1] : ''}</td>
							<td class="text-end">${((voice.bytes[40] & 0x04) !== 0) ? '+-'[((voice.bytes[40] & 0x40) === 0) ? 0 : 1] : ''}</td>
							<td class="text-end">${((voice.bytes[40] & 0x08) !== 0) ? '+-'[((voice.bytes[40] & 0x80) === 0) ? 0 : 1] : ''}</td>
						</tr>
						<tr>
							<th>VelSense</th>
							<td class="text-end">${((voice.bytes[41] & 0x01) !== 0) ? '+-'[((voice.bytes[41] & 0x10) === 0) ? 0 : 1] : ''}</td>
							<td class="text-end">${((voice.bytes[41] & 0x02) !== 0) ? '+-'[((voice.bytes[41] & 0x20) === 0) ? 0 : 1] : ''}</td>
							<td class="text-end">${((voice.bytes[41] & 0x04) !== 0) ? '+-'[((voice.bytes[41] & 0x40) === 0) ? 0 : 1] : ''}</td>
							<td class="text-end">${((voice.bytes[41] & 0x08) !== 0) ? '+-'[((voice.bytes[41] & 0x80) === 0) ? 0 : 1] : ''}</td>
						</tr>
					</tbody>
				</table>
				<table class="table table-sm">
					<tbody>
						<tr>
							<th>OSC Level</th>
							<td class="text-end">${voice.bytes[25]}</td>
						</tr>
						<tr>
							<th>VDA KbdTrk Key</th>
							<td class="text-end">${fmt.noteNameR(voice.bytes[26])}</td>
						</tr>
						<tr>
							<th>VDA KbdTrk Mode</th>
							<td class="text-end">${['Off', 'Low', 'High', 'All'][(voice.bytes[44] >> 4) & 0x03]}</td>
						</tr>
						<tr>
							<th>VDA KbdTrk</th>
							<td class="text-end">${fmt.sint8(voice.bytes[27])}</td>
						</tr>
						<tr>
							<th>VDA VelSense</th>
							<td class="text-end">${fmt.sint8(voice.bytes[28])}</td>
						</tr>
					</tbody>
				</table>
				<table class="table table-sm">
					<tbody>
						<tr>
							<th>A.EG Time KbdTrk</th>
							<td class="text-end">${voice.bytes[29]}</td>
						</tr>
						<tr>
							<th>A.EG Time VelSense</th>
							<td class="text-end">${voice.bytes[30]}</td>
						</tr>
					</tbody>
				</table>
			</div>
		</div>
	</div>
`;

const templateTone = (tone, json) => html`
	<div class="card mb-3">
		<div class="card-header">
			<h2 class="h6 mb-0">Program No.${tone.toneNo}: <span class="font-monospace h4">${tone.name}</span></h2>
		</div>
		<div class="card-body d-flex flex-row">
			<table class="table table-sm w-auto me-3">
				<tbody>
					<tr>
						<th>OSC Mode</th>
						<td class="text-end">${['Single', 'Double', 'Drum'][tone.commonBytes[0]] ?? 'Unknown'}</td>
					</tr>
					<tr>
						<th>OSC Hold</th>
						<td class="text-end">${((tone.commonBytes[0] & 0x08) !== 0) ? 'On' : 'Off'}</td>
					</tr>
					<tr>
						<th>OSC Interval</th>
						<td class="text-end">${fmt.sint8(tone.commonBytes[5])}</td>
					</tr>
					<tr>
						<th>OSC Detune </th>
						<td class="text-end">${fmt.sint8(tone.commonBytes[6])}</td>
					</tr>
					<tr>
						<th>OSC Delay Start</th>
						<td class="text-end">${tone.commonBytes[7]}</td>
					</tr>
				</tbody>
			</table>
			<div class="me-3">
				<table class="table table-sm">
					<thead>
						<tr>
							<th>P.EG</th>
							<th class="text-end">S</th>
							<th class="text-end">A</th>
							<th class="text-end">D</th>
							<th class="text-end">R</th>
						</tr>
					</thead>
					<tbody>
						<tr>
							<th>Time</th>
							<td class="text-end">-</td>
							<td class="text-end">${tone.commonBytes[9]}</td>
							<td class="text-end">${tone.commonBytes[11]}</td>
							<td class="text-end">${tone.commonBytes[12]}</td>
						</tr>
						<tr>
							<th>Level</th>
							<td class="text-end">${fmt.sint8(tone.commonBytes[8])}</td>
							<td class="text-end">${fmt.sint8(tone.commonBytes[10])}</td>
							<td class="text-end">-</td>
							<td class="text-end">${fmt.sint8(tone.commonBytes[13])}</td>
						</tr>
					</tbody>
				</table>
				<table class="table table-sm">
					<tbody>
						<tr>
							<th>P.EG TimeVelSense</th>
							<td class="text-end">${fmt.sint8(tone.commonBytes[14])}</td>
						</tr>
						<tr>
							<th>P.EG LevelVelSense</th>
							<td class="text-end">${fmt.sint8(tone.commonBytes[15])}</td>
						</tr>
					</tbody>
				</table>
			</div>
			<div class="me-3">
				<table class="table table-sm">
					<tbody>
						<tr>
							<th>VDF MG Waveform</th>
							<td class="text-end">${['Tri', 'SawUp', 'SawDn', 'Sq', 'Random'][tone.commonBytes[16] & 0x07] ?? 'Unknown'}</td>
						</tr>
						<tr>
							<th>VDF MG OSC 1</th>
						<td class="text-end">${((tone.commonBytes[16] & 0x20) !== 0) ? 'On' : 'Off'}</td>
						</tr>
						<tr>
							<th>VDF MG OSC 2</th>
						<td class="text-end">${((tone.commonBytes[16] & 0x40) !== 0) ? 'On' : 'Off'}</td>
						</tr>
						<tr>
							<th>VDF MG Frequency</th>
							<td class="text-end">${tone.commonBytes[17]}</td>
						</tr>
						<tr>
							<th>VDF MG Delay</th>
							<td class="text-end">${tone.commonBytes[18]}</td>
						</tr>
						<tr>
							<th>VDF MG Intensity</th>
							<td class="text-end">${tone.commonBytes[19]}</td>
						</tr>
					</tbody>
				</table>
			</div>
			<div class="me-3">
				<table class="table table-sm">
					<tbody>
						<tr>
							<th>AftT Bend Range</th>
							<td class="text-end">${fmt.sint8(tone.commonBytes[20])}</td>
						</tr>
						<tr>
							<th>AftT VDF Cutoff</th>
							<td class="text-end">${fmt.sint8(tone.commonBytes[21])}</td>
						</tr>
						<tr>
							<th>AftT VDF MG</th>
							<td class="text-end">${tone.commonBytes[22]}</td>
						</tr>
						<tr>
							<th>AftT VDA Amp</th>
							<td class="text-end">${fmt.sint8(tone.commonBytes[23])}</td>
						</tr>
					</tbody>
				</table>
				<table class="table table-sm w-auto mb-0">
					<tbody>
						<tr>
							<th>Mod Bend VDF Sweep</th>
							<td class="text-end">${fmt.sint8(tone.commonBytes[24])}</td>
						</tr>
						<tr>
							<th>Mod2 VDF MG</th>
							<td class="text-end">${tone.commonBytes[25]}</td>
						</tr>
					</tbody>
				</table>
			</div>
		</div>
	</div>
	${tone.voices.map((voice) => templateVoice(voice, json))}
`;

window.addEventListener('DOMContentLoaded', async () => {
	const elemModal = new bootstrap.Modal(document.getElementById('my-modal'));
	const modalContent = document.getElementById('my-modal-content');

	elemModal.show();

	// Loads a JSON file.
	const url = (window.location.search.startsWith('?')) ? window.location.search.slice(1) : 'ag-10.json';
	const res = await fetch(url);
	if (!res.ok) {
		modalContent.textContent = `Error: "${url}" not found.`;
		return;
	}
	const json = await res.json();
	modalContent.textContent = '';

	// Adds event handlers.
	window.addEventListener('hashchange', handleHashChange);
	document.getElementById('my-modal').addEventListener('hide.bs.modal', () => {
		if (window.location.hash !== '' && window.history.length > 2) {
			window.history.back();
		} else {
			window.location.hash = '';
		}
	});

	// Renders lists on each tab pane.
	render(templateToneList(json), document.getElementById('my-pane-tones'));
	render(templateWaveList(json), document.getElementById('my-pane-waves'));

	handleHashChange();

	function handleHashChange() {
		// Checks whether the current URL hash is a supported format or not.
		const m = window.location.hash.match(/^#\/(.*)\/(\d+)/u);
		if (!m) {
			elemModal.hide();
			return;
		}

		// Renders information on the modal according to the specified URL hash.
		const no = Number(m[2]);
		switch (m[1]) {
		case 'tones':
			render(templateTone(json.tones[no], json), modalContent);
			break;
		default:
			elemModal.hide();
			return;
		}

		// Shows the modal.
		document.getElementById('my-modal-title').textContent = window.location.hash;
		elemModal.show();
	}
});
</script>
<body>
	<!-- Navbar -->
	<nav class="navbar sticky-top bg-light">
		<div class="container align-items-start">
			<h1 class="h5 mt-1 mb-0">tone-browser</h1>
			<a href="#" class="btn btn-outline-primary py-1">Top</a>
		</div>
	</nav>

	<!-- Main screen -->
	<main class="container mt-2">
		<ul class="nav nav-tabs" role="tablist">
			<li class="nav-item" role="presentation">
				<button id="my-tab-tones" class="nav-item nav-link active" role="tab" data-bs-toggle="tab" data-bs-target="#my-pane-tones">Programs</button>
			</li>
			<li class="nav-item" role="presentation">
				<button id="my-tab-waves" class="nav-item nav-link" role="tab" data-bs-toggle="tab" data-bs-target="#my-pane-waves">Samples</button>
			</li>
		</ul>
		<div class="tab-content mt-2">
			<div id="my-pane-tones" class="tab-pane fade show active" role="tabpanel"></div>
			<div id="my-pane-waves" class="tab-pane fade" role="tabpanel"></div>
		</div>
	</main>

	<!-- Information modal -->
	<div id="my-modal" class="modal" tabindex="-1" role="dialog">
		<div class="modal-dialog modal-dialog-scrollable modal-xl my-modal-fluid" role="document">
			<div class="modal-content">
				<div class="modal-header">
					<h2 id="my-modal-title" class="modal-title h6 text-black-50"></h2>
					<button type="button" class="btn-close" data-bs-dismiss="modal"></button>
				</div>
				<div class="modal-body">
					<div id="my-modal-content" class="container-fluid">
						Loading...
					</div>
				</div>
			</div>
		</div>
	</div>
</body>
</html>
